namespace Belin.Sql.Reflection;

using System.ComponentModel.DataAnnotations.Schema;
using System.Reflection;

/// <summary>
/// Provides information about a database column.
/// </summary>
/// <param name="property">The property information providing the column metadata.</param>
public sealed class ColumnInfo(PropertyInfo property) {

	/// <summary>
	/// The nullability context.
	/// </summary>
	private static readonly NullabilityInfoContext nullabilityContext = new();

	/// <summary>
	/// Value indicating whether the column can be read.
	/// </summary>
	public bool CanRead => property.CanRead;

	/// <summary>
	/// Value indicating whether the column can be written to.
	/// </summary>
	public bool CanWrite => property.CanWrite;

	/// <summary>
	/// Value indicating whether the column value is generated by the database.
	/// </summary>
	public bool IsComputed => databaseGeneratedOption != DatabaseGeneratedOption.None;

	/// <summary>
	/// Value indicating whether the column value is generated by the database when a row is inserted.
	/// </summary>
	public bool IsIdentity => databaseGeneratedOption == DatabaseGeneratedOption.Identity;

	/// <summary>
	/// Value indicating whether the column value is nullable.
	/// </summary>
	public bool IsNullable => Nullable.GetUnderlyingType(Type) is not null || nullability.WriteState != NullabilityState.NotNull;

	/// <summary>
	/// The column name.
	/// </summary>
	public string Name { get; } = property.GetCustomAttribute<ColumnAttribute>()?.Name ?? property.Name;

	/// <summary>
	/// The type of the column value.
	/// </summary>
	public Type Type => property.PropertyType;

	/// <summary>
	/// Value indicating how the database generates values for this column.
	/// </summary>
	private readonly DatabaseGeneratedOption databaseGeneratedOption =
		property.GetCustomAttribute<DatabaseGeneratedAttribute>()?.DatabaseGeneratedOption ?? DatabaseGeneratedOption.None;

	/// <summary>
	/// The nullability information for the underlying property.
	/// </summary>
	private readonly NullabilityInfo nullability = nullabilityContext.Create(property);

	/// <summary>
	/// Gets the property value of a specified object.
	/// </summary>
	/// <param name="instance">The object whose property value will be returned.</param>
	/// <returns>The property value of the specified object.</returns>
	public object? GetValue<T>(T instance) where T: new() => property.GetValue(instance);

	/// <summary>
	/// Sets the property value of a specified object.
	/// </summary>
	/// <param name="instance">The object whose property value will be set.</param>
	/// <param name="value">The new property value.</param>
	public void SetValue<T>(T instance, object? value) where T: new() => property.SetValue(instance, value);
}
